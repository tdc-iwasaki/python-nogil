name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
    paths:
      - '3.14/**'
      - '.github/workflows/ci.yml'
      - '!**/*.md'
  workflow_dispatch:

jobs:
  docker-amd64:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: '3.14'
            variant: 'slim-trixie'
            platform: 'linux/amd64'
            is-latest: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Extract Python version from Dockerfile
        id: extract-version
        run: |
          PYTHON_FULL_VERSION=$(grep '^ENV PYTHON_VERSION' ${{ matrix.python-version }}/${{ matrix.variant }}/Dockerfile | awk '{print $3}')
          echo "python-full-version=$PYTHON_FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Python full version: $PYTHON_FULL_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image (amd64)
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.python-version }}/${{ matrix.variant }}
          file: ./${{ matrix.python-version }}/${{ matrix.variant }}/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64
          labels: |
            org.opencontainers.image.version=${{ matrix.python-version }}
            org.opencontainers.image.variant=${{ matrix.variant }}
          cache-from: type=gha,scope=${{ matrix.python-version }}-${{ matrix.variant }}-amd64
          cache-to: type=gha,mode=max,scope=${{ matrix.python-version }}-${{ matrix.variant }}-amd64

      - name: Test Docker image (amd64)
        run: |
          docker run --rm --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            python -c "
          import sys
          print(f'Python {sys.version}')
          print(f'GIL disabled: {not sys.flags.gil if hasattr(sys.flags, \"gil\") else \"unknown\"}')
          assert not sys.flags.gil, 'GIL is not disabled'
          print('✓ GIL is successfully disabled')
          "

  docker-arm64:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: '3.14'
            variant: 'slim-trixie'
            platform: 'linux/arm64'
            is-latest: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Extract Python version from Dockerfile
        id: extract-version
        run: |
          PYTHON_FULL_VERSION=$(grep '^ENV PYTHON_VERSION' ${{ matrix.python-version }}/${{ matrix.variant }}/Dockerfile | awk '{print $3}')
          echo "python-full-version=$PYTHON_FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Python full version: $PYTHON_FULL_VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image (arm64)
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.python-version }}/${{ matrix.variant }}
          file: ./${{ matrix.python-version }}/${{ matrix.variant }}/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64
          labels: |
            org.opencontainers.image.version=${{ matrix.python-version }}
            org.opencontainers.image.variant=${{ matrix.variant }}
          cache-from: type=gha,scope=${{ matrix.python-version }}-${{ matrix.variant }}-arm64
          cache-to: type=gha,mode=max,scope=${{ matrix.python-version }}-${{ matrix.variant }}-arm64

      - name: Test Docker image (arm64)
        run: |
          docker run --rm --platform linux/arm64 ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64 \
            python -c "
          import sys
          print(f'Python {sys.version}')
          print(f'GIL disabled: {not sys.flags.gil if hasattr(sys.flags, \"gil\") else \"unknown\"}')
          assert not sys.flags.gil, 'GIL is not disabled'
          print('✓ GIL is successfully disabled')
          "

  create-manifest:
    runs-on: ubuntu-latest
    needs: [docker-amd64, docker-arm64]
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: '3.14'
            variant: 'slim-trixie'
            is-latest: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Extract Python version from Dockerfile
        id: extract-version
        run: |
          PYTHON_FULL_VERSION=$(grep '^ENV PYTHON_VERSION' ${{ matrix.python-version }}/${{ matrix.variant }}/Dockerfile | awk '{print $3}')
          echo "python-full-version=$PYTHON_FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Python full version: $PYTHON_FULL_VERSION"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          PYTHON_FULL_VERSION="${{ steps.extract-version.outputs.python-full-version }}"
          
          # メインのバージョン付きタグ (3.14-slim-trixie)
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64
          
          # フルバージョン付きタグ (3.14.0-slim-trixie)
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${PYTHON_FULL_VERSION}-${{ matrix.variant }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64
          
          # Python バージョンのみのタグ (3.14)
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64
          
          # Python フルバージョンのみのタグ (3.14.0)
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${PYTHON_FULL_VERSION} \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64

      - name: Create and push latest tag
        if: matrix.is-latest && github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:latest \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64

      - name: Create and push semver tags
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f1-2)
          
          # フルバージョンタグ
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:$VERSION \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64
          
          # メジャー.マイナーバージョンタグ
          docker buildx imagetools create -t ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:$MINOR \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-amd64 \
            ${{ secrets.DOCKERHUB_USERNAME }}/python-nogil:${{ matrix.python-version }}-${{ matrix.variant }}-arm64
